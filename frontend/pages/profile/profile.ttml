<!--pages/profile/profile.ttml-->
<scroll-view scroll-y="true" style="height: 100vh;">
  <view class="container">
  <!-- è£…é¥°èƒŒæ™¯ -->
  <view class="decoration-bg">
    <view class="floating-gem gem-1">ğŸ’</view>
    <view class="floating-gem gem-2">ğŸ‘‘</view>
    <view class="floating-gem gem-3">âœ¨</view>
    <view class="floating-gem gem-4">ğŸŒŸ</view>
    <view class="floating-gem gem-5">ğŸ’«</view>
  </view>

  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="not-logged-in" wx:if="{{!isLoggedIn}}">
    <view class="login-prompt">
      <view class="prompt-icon">ğŸ”</view>
      <text class="prompt-title">è¯·å…ˆç™»å½•</text>
      <text class="prompt-subtitle">ç™»å½•åå³å¯æŸ¥çœ‹å’Œç®¡ç†ä¸ªäººä¿¡æ¯</text>
      <button class="login-btn" bindtap="goToLogin">
        <text class="btn-text">ç«‹å³ç™»å½•</text>
        <text class="btn-emoji">ğŸš€</text>
      </button>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <scroll-view class="content-container" scroll-y wx:if="{{isLoggedIn}}">
    
    <!-- ç”¨æˆ·å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯ -->
    <view class="profile-header">
      <view class="avatar-section">
        <view class="avatar-container" bindtap="uploadAvatar">
          <image 
            class="avatar-image" 
            src="{{avatarUrl || '/static/default-avatar.png'}}"
            mode="aspectFill"
          />
          <view class="avatar-edit-badge">
            <text>ğŸ“·</text>
          </view>
          <view class="avatar-glow"></view>
        </view>
        <view class="user-basic-info">
          <text class="user-nickname">{{userInfo.nickname || 'æ—¶å°šè¾¾äºº'}}</text>
          <text class="user-phone">{{userInfo.phone}}</text>
          <view class="user-signature">
            <text>{{userInfo.signature || 'è¿˜æ²¡æœ‰ä¸ªæ€§ç­¾å~'}}</text>
          </view>
        </view>
      </view>
      
      <!-- ç”¨æˆ·ç»Ÿè®¡ -->
      <view class="stats-section">
        <view class="stat-item">
          <text class="stat-number">{{userStats.analysisCount}}</text>
          <text class="stat-label">AIåˆ†æ</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{userStats.wardrobeCount}}</text>
          <text class="stat-label">è¡£æ©±å•å“</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{userStats.points}}</text>
          <text class="stat-label">ç§¯åˆ†</text>
        </view>
      </view>
    </view>

    <!-- å¿«é€ŸåŠŸèƒ½åŒº -->
    <view class="quick-actions">
      <view class="section-title">
        <text>âš¡ å¿«é€ŸåŠŸèƒ½</text>
      </view>
      <view class="action-grid">
        <view class="action-item" bindtap="goToWardrobe">
          <view class="action-icon wardrobe">ğŸ‘—</view>
          <text class="action-text">æ™ºèƒ½è¡£æ©±</text>
        </view>
        <view class="action-item" bindtap="goToAnalysis">
          <view class="action-icon analysis">ğŸ¯</view>
          <text class="action-text">AIåˆ†æ</text>
        </view>
        <view class="action-item" bindtap="openSettings">
          <view class="action-icon settings">âš™ï¸</view>
          <text class="action-text">è®¾ç½®</text>
        </view>
        <view class="action-item" bindtap="openHelp">
          <view class="action-icon help">â“</view>
          <text class="action-text">å¸®åŠ©</text>
        </view>
      </view>
    </view>

    <!-- ä¸ªäººä¿¡æ¯ç¼–è¾‘ -->
    <view class="profile-info">
      <view class="section-header">
        <text class="section-title">ğŸ“ ä¸ªäººä¿¡æ¯</text>
        <view class="edit-toggle" bindtap="{{isEditing ? 'cancelEdit' : 'startEdit'}}">
          <text class="edit-text">{{isEditing ? 'å–æ¶ˆ' : 'ç¼–è¾‘'}}</text>
        </view>
      </view>

      <view class="info-form">
        <!-- æ˜µç§° -->
        <view class="form-item">
          <text class="form-label">æ˜µç§°</text>
          <view class="form-value">
            <input 
              wx:if="{{isEditing}}"
              class="form-input"
              placeholder="è¯·è¾“å…¥æ˜µç§°"
              value="{{editForm.nickname}}"
              bindinput="onInputChange"
              data-field="nickname"
              maxlength="50"
            />
            <text wx:else class="display-value">{{userInfo.nickname || 'æœªè®¾ç½®'}}</text>
          </view>
          <view class="form-error" wx:if="{{errors.nickname}}">
            <text>{{errors.nickname}}</text>
          </view>
        </view>

        <!-- ä¸ªæ€§ç­¾å -->
        <view class="form-item">
          <text class="form-label">ä¸ªæ€§ç­¾å</text>
          <view class="form-value">
            <textarea 
              wx:if="{{isEditing}}"
              class="form-textarea"
              placeholder="å†™ä¸‹ä½ çš„ä¸ªæ€§ç­¾å..."
              value="{{editForm.signature}}"
              bindinput="onInputChange"
              data-field="signature"
              maxlength="200"
              auto-height
            />
            <text wx:else class="display-value signature">{{userInfo.signature || 'è¿˜æ²¡æœ‰ä¸ªæ€§ç­¾å~'}}</text>
          </view>
          <view class="form-error" wx:if="{{errors.signature}}">
            <text>{{errors.signature}}</text>
          </view>
        </view>

        <!-- æ€§åˆ« -->
        <view class="form-item">
          <text class="form-label">æ€§åˆ«</text>
          <view class="form-value">
            <view 
              wx:if="{{isEditing}}"
              class="form-picker"
              bindtap="showPicker"
              data-type="Gender"
            >
              <text class="picker-text">{{editForm.gender || 'è¯·é€‰æ‹©æ€§åˆ«'}}</text>
              <text class="picker-arrow">></text>
            </view>
            <text wx:else class="display-value">{{userInfo.gender || 'æœªè®¾ç½®'}}</text>
          </view>
        </view>

        <!-- èº«é«˜ -->
        <view class="form-item">
          <text class="form-label">èº«é«˜</text>
          <view class="form-value">
            <view class="input-with-unit" wx:if="{{isEditing}}">
              <input 
                class="form-input number-input"
                type="digit"
                placeholder="è¯·è¾“å…¥èº«é«˜"
                value="{{editForm.height}}"
                bindinput="onInputChange"
                data-field="height"
              />
              <text class="input-unit">cm</text>
            </view>
            <text wx:else class="display-value">{{userInfo.height ? userInfo.height + 'cm' : 'æœªè®¾ç½®'}}</text>
          </view>
          <view class="form-error" wx:if="{{errors.height}}">
            <text>{{errors.height}}</text>
          </view>
        </view>

        <!-- ä½“é‡ -->
        <view class="form-item">
          <text class="form-label">ä½“é‡</text>
          <view class="form-value">
            <view class="input-with-unit" wx:if="{{isEditing}}">
              <input 
                class="form-input number-input"
                type="digit"
                placeholder="è¯·è¾“å…¥ä½“é‡"
                value="{{editForm.weight}}"
                bindinput="onInputChange"
                data-field="weight"
              />
              <text class="input-unit">kg</text>
            </view>
            <text wx:else class="display-value">{{userInfo.weight ? userInfo.weight + 'kg' : 'æœªè®¾ç½®'}}</text>
          </view>
          <view class="form-error" wx:if="{{errors.weight}}">
            <text>{{errors.weight}}</text>
          </view>
        </view>

        <!-- ä½“å‹ -->
        <view class="form-item">
          <text class="form-label">ä½“å‹</text>
          <view class="form-value">
            <view 
              wx:if="{{isEditing}}"
              class="form-picker"
              bindtap="showPicker"
              data-type="BodyShape"
            >
              <text class="picker-text">{{editForm.body_shape || 'è¯·é€‰æ‹©ä½“å‹'}}</text>
              <text class="picker-arrow">></text>
            </view>
            <text wx:else class="display-value">{{userInfo.body_shape || 'æœªè®¾ç½®'}}</text>
          </view>
        </view>

        <!-- è‚¤è‰² -->
        <view class="form-item">
          <text class="form-label">è‚¤è‰²ç±»å‹</text>
          <view class="form-value">
            <view 
              wx:if="{{isEditing}}"
              class="form-picker"
              bindtap="showPicker"
              data-type="SkinTone"
            >
              <text class="picker-text">{{editForm.skin_tone || 'è¯·é€‰æ‹©è‚¤è‰²ç±»å‹'}}</text>
              <text class="picker-arrow">></text>
            </view>
            <text wx:else class="display-value">{{userInfo.skin_tone || 'æœªè®¾ç½®'}}</text>
          </view>
        </view>

        <!-- ä¿å­˜æŒ‰é’® -->
        <view class="save-section" wx:if="{{isEditing}}">
          <button 
            class="save-btn {{isLoading ? 'loading' : ''}}"
            bindtap="saveProfile"
            disabled="{{isLoading}}"
          >
            <view wx:if="{{!isLoading}}" class="btn-content">
              <text class="btn-text">ä¿å­˜ä¿¡æ¯</text>
              <text class="btn-emoji">ğŸ’¾</text>
            </view>
            <view wx:else class="btn-loading">
              <view class="loading-spinner"></view>
              <text class="loading-text">ä¿å­˜ä¸­...</text>
            </view>
          </button>
        </view>
      </view>
    </view>

    <!-- å…¶ä»–åŠŸèƒ½ -->
    <view class="other-functions">
      <view class="section-title">
        <text>ğŸ”§ å…¶ä»–åŠŸèƒ½</text>
      </view>
      
      <view class="function-list">
        <view class="function-item" bindtap="changePassword">
          <view class="function-icon">ğŸ”’</view>
          <text class="function-text">ä¿®æ”¹å¯†ç </text>
          <text class="function-arrow">></text>
        </view>
        
        <view class="function-item" bindtap="openAbout">
          <view class="function-icon">â„¹ï¸</view>
          <text class="function-text">å…³äºæˆ‘ä»¬</text>
          <text class="function-arrow">></text>
        </view>
        
        <view class="function-item logout-item" bindtap="logout">
          <view class="function-icon">ğŸšª</view>
          <text class="function-text">é€€å‡ºç™»å½•</text>
          <text class="function-arrow">></text>
        </view>
      </view>
    </view>

  </scroll-view>

  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <view class="bottom-nav">
    <view class="nav-item" bindtap="switchTab" data-tab="index">
      <view class="nav-icon">ğŸ </view>
      <text class="nav-text">é¦–é¡µ</text>
    </view>
    
    <view class="nav-item" bindtap="switchTab" data-tab="analysis">
      <view class="nav-icon">ğŸ¯</view>
      <text class="nav-text">AIåˆ†æ</text>
    </view>
    
    <view class="nav-item" bindtap="switchTab" data-tab="wardrobe">
      <view class="nav-icon">ğŸ‘—</view>
      <text class="nav-text">è¡£æ©±</text>
    </view>
    
    <view class="nav-item nav-active" bindtap="switchTab" data-tab="profile">
      <view class="nav-icon">ğŸ‘¤</view>
      <text class="nav-text">æˆ‘çš„</text>
    </view>
  </view>
</view>

<!-- æ€§åˆ«é€‰æ‹©å™¨ -->
<view class="picker-overlay" wx:if="{{showGenderPicker}}" bindtap="hidePicker" data-type="Gender">
  <view class="picker-content" catchtap>
    <view class="picker-header">
      <text class="picker-title">é€‰æ‹©æ€§åˆ«</text>
      <view class="picker-close" bindtap="hidePicker" data-type="Gender">Ã—</view>
    </view>
    <view class="picker-options">
      <view 
        class="picker-option {{editForm.gender === item.value ? 'selected' : ''}}"
        wx:for="{{genderOptions}}"
        wx:key="value"
        bindtap="selectOption"
        data-type="Gender"
        data-value="{{item.value}}"
      >
        <text class="option-icon">{{item.icon}}</text>
        <text class="option-text">{{item.label}}</text>
        <text class="option-check" wx:if="{{editForm.gender === item.value}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- ä½“å‹é€‰æ‹©å™¨ -->
<view class="picker-overlay" wx:if="{{showBodyShapePicker}}" bindtap="hidePicker" data-type="BodyShape">
  <view class="picker-content" catchtap>
    <view class="picker-header">
      <text class="picker-title">é€‰æ‹©ä½“å‹</text>
      <view class="picker-close" bindtap="hidePicker" data-type="BodyShape">Ã—</view>
    </view>
    <view class="picker-options">
      <view 
        class="picker-option {{editForm.body_shape === item.value ? 'selected' : ''}}"
        wx:for="{{bodyShapeOptions}}"
        wx:key="value"
        bindtap="selectOption"
        data-type="BodyShape"
        data-value="{{item.value}}"
      >
        <view class="option-content">
          <text class="option-text">{{item.label}}</text>
          <text class="option-desc">{{item.desc}}</text>
        </view>
        <text class="option-check" wx:if="{{editForm.body_shape === item.value}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- è‚¤è‰²é€‰æ‹©å™¨ -->
<view class="picker-overlay" wx:if="{{showSkinTonePicker}}" bindtap="hidePicker" data-type="SkinTone">
  <view class="picker-content" catchtap>
    <view class="picker-header">
      <text class="picker-title">é€‰æ‹©è‚¤è‰²ç±»å‹</text>
      <view class="picker-close" bindtap="hidePicker" data-type="SkinTone">Ã—</view>
    </view>
    <view class="picker-options">
      <view 
        class="picker-option {{editForm.skin_tone === item.value ? 'selected' : ''}}"
        wx:for="{{skinToneOptions}}"
        wx:key="value"
        bindtap="selectOption"
        data-type="SkinTone"
        data-value="{{item.value}}"
      >
        <view class="option-content">
          <text class="option-text">{{item.label}}</text>
          <text class="option-desc">{{item.desc}}</text>
        </view>
        <text class="option-check" wx:if="{{editForm.skin_tone === item.value}}">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- AIæ‚¬æµ®çƒ -->
<ai-floating-bot 
  visible="{{true}}"
  is-online="{{true}}"
  message-count="{{0}}"
  bind:botclick="onAIBotClick"
  pageContext="profile">
</ai-floating-bot>